/***************************************
* @preserve
* ForeSee Web SDK: Tracker Window
* Built April 27, 19 21:44:44
* Code version: 19.6.6
* Template version: 19.6.6
***************************************/
_fsDefine(["require","fs",_fsNormalizeUrl("fs.utils.js")],function(e,t,i){t.config.brainUrl=t.getParam("brain_url")||t.config.brainUrl;var r={INVITE_SHOWN:"fs_inviteShown",INVITE_ACCEPTED:"fs_inviteAccepted",INVITE_DECLINED:"fs_inviteDeclined",INVITE_ABANDONED:"fs_inviteAbandoned",TRACKER_SHOWN:"fs_trackerShown",TRACKER_CLICKED:"fs_trackerClicked",QUALIFIER_ACCEPTED:"fs_qualifierAccepted",QUALIFIER_DECLINED:"fs_qualifierDeclined",QUALIFIER_SHOWN:"fs_qualifierShown",REMINDER_SHOWN:"fs_reminderShown",REMINDER_ACCEPTED:"fs_reminderAccepted"},s=function(e,t){var i;return i=new window.Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+e.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');"),t?i(t):i},a=function(e,r,s,a,n,o){this.br=e,this.data=s,this.qual=a,this.cpps=r,this.templatehtml=n,this.displayOpts=o,this.userLocale=this.data.cfg.active_surveydef.language.locale||"en",this.qualified=new i.FSEvent,this.disqualified=new i.FSEvent,this.validationFailed=new i.FSEvent,this.qualifiesValue=null,"en"!==this.userLocale&&t.isDefined(this.data.cfg.active_surveydef.qualifier.survey.locales[this.userLocale])&&(this.qual.survey=t.ext({},cfg.active_surveydef.qualifier.survey.locales[this.userLocale]));for(var l,c=this.qual.survey.questions.length,u=0;u<c;u++){l=this.qual.survey.questions[u];for(var d=0;d<l.choices.length;d++)t.ext(l.choices[d],{id:"q"+u+"c"+d,value:"q"+u+"c"+d,name:"q"+u,type:t.toLowerCase(l.questionType)})}this.disqualified.subscribe(t.proxy(function(){this.showNoThanks()},this)),this.validationFailed.subscribe(t.proxy(function(e){alert(e)},this))};a.prototype.render=function(){var e=t.ext({},this.displayOpts,{qual:this.qual});document.documentElement.setAttribute("id","fsrQualifier"),document.body.innerHTML=s(this.templatehtml,e),i.Bind(document.getElementById("qualifierForm"),"qualifier:submit",t.proxy(function(e){i.preventDefault(e),this.validateAndSubmit()},this)),i.Bind(document.getElementById("qualCancelButton"),"qualifier:click",t.proxy(function(e){i.preventDefault(e),this.disqualified.fire()},this)),i.Bind(document.getElementById("qualCloseButton"),"qualifier:click",t.proxy(function(e){i.preventDefault(e),window.close()},this))},a.prototype.validateAndSubmit=function(){for(var e=document.querySelectorAll(".activeQuestion"),t=[],i=!1,r=0;r<e.length;r++){var s=parseInt(e[r].getAttribute("questionNum")),a=this.qual.survey.questions[s];if("RADIO"==a.questionType){for(var n=document.getElementsByName("q"+s),o=!1,l=0;l<n.length;l++)if(n[l].checked){o=!0,t.push(a.choices[l]);break}if(!o){i=!0;break}}}if(i)this.validationFailed.fire(this.qual.survey.validationFailedMsg);else{for(var c=!1,u=0;u<t.length;u++){var d=t[u];if(this.qualifiesValue=d.qualifies||null,d.cpps&&d.cpps.length>0)for(var h=0;h<d.cpps.length;h++)for(var f in d.cpps[h])this.cpps.set(f,d.cpps[h][f]);if(!1===d.qualifies){c=!0;break}}!0===c?this.disqualified.fire():this.qualified.fire()}},a.prototype.showNoThanks=function(){i.addClass(document.getElementById("fsrQualifierMain"),"acsNoDisplay"),i.removeClass(document.getElementById("fsrQualifierNoThanks"),"acsNoDisplay")};var n=function(e,t,r,s,a,n){this.br=e,this.data=r,this.rmdr=s,this.lng=r.cfg.active_surveydef.language.locale,this.cpps=t,this.templatehtml=a,this.displayOpts=n,this.accepted=new i.FSEvent};n.prototype.render=function(){var e,r;document.documentElement.setAttribute("id","fsrReminder"),r=t.ext({},this.rmdr),"en"!==this.lng&&t.isDefined(this.rmdr.display.locales[this.lng])&&(r.display=this.rmdr.display.locales[this.lng]),e=t.ext({},this.displayOpts,{rmdr:r}),document.body.innerHTML=s(this.templatehtml,e),i.Bind(document.getElementById("reminderForm"),"reminder:submit",t.proxy(function(e){i.preventDefault(e),this.accepted.fire()},this))};var o=function(config,e,i,r){this.cfg=config,this.globalConfig=config.globalConfig||t.config,this.cpps=e,this.def=i,this.locale=e.get("locale")||"en",this.qual=r},l=function(e,t){var i,r,config,s=t.name||"";for(s+="-"+(t.section||""),s+="-"+(t.site||""),i=0;i<e.defs.length;i++)if(config=e.defs[i],r=config.name||"",r+="-"+(config.section||""),(r+="-"+(config.site||""))===s)return config;return null};o.prototype.decideModernSurvey=function(){var e=this.cfg.config.abSurveyType,t=e&&e.shouldTest&&this.globalConfig.modernSurveyUrl,i=t&&l(e,this.def);return this.cfg.config.onlyModernSurvey?{modernChosen:!0,modernPercentage:100}:i?{modernChosen:i.modernPercentage>=Math.floor(100*Math.random()),modernPercentage:i.modernPercentage}:{modernChosen:!1,modernPercentage:0}},o.prototype.getUrl=function(){var e,r=this.def,s=i.now()+"_"+Math.round(1e13*Math.random()),a=r.name+"-"+(t.isDefined(r.site)?r.site+"-":"")+(t.isDefined(r.section)?this.def.section+"-":"")+this.locale,n=this.decideModernSurvey();this.qual&&(a+="-"+this.qual.qualifiesValue);var o={sid:a,cid:this.cfg.config.id,pattern:this.cpps.get(r.pattern)||r.pattern,a:s,b:i.hash(s),c:864e5,mp:n.modernPercentage};e=n.modernChosen?this.globalConfig.modernSurveyUrl:this.globalConfig.surveyUrl,e+="?";for(var l in o)e+=t.enc(l)+"="+t.enc(o[l])+"&";return e+=this.cpps.toQueryString()};var c=function(e){this.gs=e};c.prototype={_extras:{},set:function(e,t){this.all()[e]=t,this._extras[e]=t},get:function(e){return this.all()[e]},all:function(){return t.ext({},this.gs.get("cp")||{},this._extras)},toQueryString:function(){var e=[],i=this.all();for(var r in i)e.push("cpp["+t.enc(r)+"]="+t.enc(i[r]));return e.join("&")},erase:function(e){var t=this.all();delete t[e],this.gs.set("cp",t)},append:function(e,t,i){var r=this.gs.get("cp")||{};if(r[e]=(r[e]||"")+","+t,i){var s=r[e].split(","),a=s.length-1,n=s.length>i?s.length-i:0;r[e]=s.splice(n,a-n+1).join()}this.gs.set("cp",r)}};var u="undefined"!=typeof config?config.config.surveyAsyncCurl:"i.4see.mobi";if({SERVICE_TYPES:{survey:{host:"survey.foreseeresults.com",path:"/survey",url:"/display",protocol:"https"},mobileOnExitInitialize:{host:u,path:"/e",url:"/initialize"},mobileOnExitHeartbeat:{host:u,path:"/e",url:"/recordHeartbeat"},check:{host:"controller.4seeresults.com",path:"/fsrSurvey",url:"/OTCImg",success:3},event:{host:"events.foreseeresults.com",path:"/rec",url:"/process?event=logit"},domain:{host:"survey.foreseeresults.com",path:"/survey",url:"/FSRImg",success:3},replay:{host:"replaycontroller.4seeresults.com",path:"/images",enabled:!0}}}.ping=function(e,t,r,s){(new i.ImageTransport).send({url:"https://"+e.host+e.path+(e.url||""),success:r||function(){},failure:s||function(){},data:t})},!window.btoa){var d="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",h=new Array(-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-1,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,-1,-1,-1,-1,-1);window.btoa=function(e){var t,i,r,s,a,n;for(r=e.length,i=0,t="";r>i;){if(s=255&e.charCodeAt(i++),i==r){t+=d.charAt(s>>2),t+=d.charAt((3&s)<<4),t+="==";break}if(a=e.charCodeAt(i++),i==r){t+=d.charAt(s>>2),t+=d.charAt((3&s)<<4|(240&a)>>4),t+=d.charAt((15&a)<<2),t+="=";break}n=e.charCodeAt(i++),t+=d.charAt(s>>2),t+=d.charAt((3&s)<<4|(240&a)>>4),t+=d.charAt((15&a)<<2|(192&n)>>6),t+=d.charAt(63&n)}return t},window.atob=function(e){var t,i,r,s,a,n,o;for(n=e.length,a=0,o="";n>a;){do{t=h[255&e.charCodeAt(a++)]}while(n>a&&-1==t);if(-1==t)break;do{i=h[255&e.charCodeAt(a++)]}while(n>a&&-1==i);if(-1==i)break;o+=String.fromCharCode(t<<2|(48&i)>>4);do{if(61==(r=255&e.charCodeAt(a++)))return o;r=h[r]}while(n>a&&-1==r);if(-1==r)break;o+=String.fromCharCode((15&i)<<4|(60&r)>>2);do{if(61==(s=255&e.charCodeAt(a++)))return o;s=h[s]}while(n>a&&-1==s);if(-1==s)break;o+=String.fromCharCode((3&r)<<6|s)}return o}}var f=function(e,r,s){var a=s.cfg.config,n=t.config.customerId||a.id||i.getRootDomain();this.br=e,this.stg=r,this.data=s,this._stage=1,this.jrny=new i.Journey(n,i.APPID.TRIGGER,r.get("rid"),e,50);var o=this.data.cfg.active_surveydef;this.jrny.addEventsDefault("properties",{fs_site:[i.getRootDomain()],fs_repeatDaysAccept:[a.repeatDays.accept],fs_repeatDaysDecline:[a.repeatDays.decline],fs_reinviteDelayAfterInviteAbandon:[a.reinviteDelayAfterInviteAbandon],fs_defName:[o.name],fs_section:[o.section],fs_displayName:[this.data.display.displayname],fs_language:[o.locale],fs_samplePercentage:[o.criteria.sp.reg],fs_loyaltyFactor:[o.criteria.lf]}),this.cpps=new c(this.stg),t.ext(this.cpps._extras,s.cpps),this._loadResources(t.proxy(function(){document.documentElement.style.backgroundImage="none",this.ready.fire(),r.onSync.subscribe(t.proxy(function(){r.get("page_hb")||(r.onSync.unsubscribeAll(),this.launchSurveyOrQualifier(),this.data.display.removeSurveyAlerts||setTimeout(t.proxy(function(){var e=t.toLowerCase(navigator.userAgent);-1==e.indexOf("msie")&&-1==e.indexOf("edge")&&-1==e.indexOf("firefox")&&this.data.display.dialog&&alert(this.data.display.dialog.surveyavailable)},this),200))},this))},this)),this.ready=new i.FSEvent};f.prototype.update=function(e,t,i){this.br=e,this.stg=t,this.data=i},f.prototype.setCPPS=function(e){if(e){this.jrny.addEventsDefault("properties",{fs_pvInvited:[e.pv]});for(var t in e)this.cpps.set(t,e[t])}},f.prototype._loadResources=function(e){if(this.data&&this.data.template&&"string"==typeof this.data.template){var r=this.data.template,s=r.indexOf("@")>-1,a=t.makeURI("templates/trigger/"+r+"/main.css"),n=t.makeURI("templates/trigger/"+r+"/tracker.html"),o=t.makeURI("templates/trigger/"+r+"/qualifier.html"),l=t.makeURI("templates/trigger/"+r+"/reminder.html"),c=t.getParam("gw");s&&(r=r.substr(1),t.isSelfHosted?(a=t.makeAssetURI("trigger/templates/"+r+"/main.css"),n=t.makeAssetURI("trigger/templates/"+r+"/tracker.html"),o=t.makeAssetURI("trigger/templates/"+r+"/qualifier.html"),l=t.makeAssetURI("trigger/templates/"+r+"/reminder.html")):(a=c.replace(/__gwtest__/g,"templates/"+r+"/main.css"),n=c.replace(/__gwtest__/g,"templates/"+r+"/tracker.html"),o=c.replace(/__gwtest__/g,"templates/"+r+"/qualifier.html"),l=c.replace(/__gwtest__/g,"templates/"+r+"/reminder.html"))),this.queue=new i.Async(!0,t.proxy(function(){e&&e()},this),t.proxy(function(){},this)),this.queue.enqueue(t.proxy(function(e){i.loadCSS(a,t.proxy(function(t){this._cssLink=t,e&&e.resolve()},this),null,this.br)},this)),this.queue.enqueue(t.proxy(function(e){new i.JSONP({success:t.proxy(function(t){this.templatehtml=t,e&&e.resolve()},this)}).get(n,"templates_trigger_"+r+"_")},this)),this.queue.enqueue(t.proxy(function(e){new i.JSONP({success:t.proxy(function(t){this.qualhtml=t,e&&e.resolve()},this)}).get(o,"templates_trigger_"+r+"_")},this)),this.queue.enqueue(t.proxy(function(e){new i.JSONP({success:t.proxy(function(t){this.rmdrhtml=t,e&&e.resolve()},this)}).get(l,"templates_trigger_"+r+"_")},this))}},f.prototype.renderTemplate=function(){var e=this.data.cfg.active_surveydef.language.locale||"en";this.data.display.inviteType=this.data.display.inviteType.toUpperCase();var a=t.ext({copyrightDate:(new Date).getFullYear().toString(),supportsSVG:document.implementation.hasFeature("http://www.w3.org/TR/SVG11/feature#BasicStructure","1.1")},this.data.display,this.data.cfg.config),n=t.getParam("gw");a.trackerLogo&&a.trackerLogo.length>0&&(t.isDefined(t.assetLocation)&&"undefined"!=t.assetLocation?a.trackerLogo=t.makeAssetURI("trigger/"+a.trackerLogo):a.trackerLogo=n.replace(/__gwtest__/g,a.trackerLogo)),a.vendorLogo&&a.vendorLogo.length>0&&(a.vendorLogo=t.makeAssetURI(a.vendorLogo)),a.vendorLogoPNG&&a.vendorLogoPNG.length>0&&(a.vendorLogoPNG=t.makeAssetURI(a.vendorLogoPNG)),a.trusteLogo&&a.trusteLogo.length>0&&(a.trusteLogo=t.makeAssetURI(a.trusteLogo)),a.loadImg=t.makeURI("loadimg.gif"),this._displayOpts=a,document.title=a.dialog.trackerTitle,document.body.innerHTML=s(this.templatehtml,a),document.documentElement.setAttribute("lang",e),this._doSizing(),this._cvTimeout?2==this._stage&&this._convertTracker():this._cvTimeout=setTimeout(t.proxy(function(){this._stage=2,this._convertTracker()},this),this.data.cfg.config.trackerConvertsAfter),i.Bind(window,"tracker:resize",t.proxy(function(){this._doSizing()},this)),this.jrny.addEventString(r.TRACKER_SHOWN)},f.prototype._doSizing=function(){var e=document.querySelectorAll("*[acsfill=true]"),t=i.getSize(window);if(e)for(var r=0;r<e.length;r++){var s=e[r],a=s.offsetLeft,n=s.offsetTop;s.style.height=t.h-n-1*a+"px"}var o=document.querySelectorAll("*[acscentervertically=true]");if(o)for(var l=0;l<o.length;l++){var c=o[l],u=c.offsetHeight,d=c.parentNode.offsetHeight;c.style.marginTop=(d-u)/2+"px"}},f.prototype._convertTracker=function(){var e,s=document.querySelectorAll(".initialContent");for(e=0;e<s.length;e++)i.addClass(s[e],"acsNoDisplay");var a=document.querySelectorAll(".showLater");for(e=0;e<a.length;e++)i.addClass(a[e],"acsDisplay");this._doSizing(),i.addClass(document.body,"acsActiveTracker");var n=document.querySelectorAll("*[acsactivatebutton=true]"),o=t.proxy(function(){this.jrny.addEventString(r.TRACKER_CLICKED),this.launchSurveyOrQualifier()},this),l=function(e){13===(window.event?e.which:e.keyCode)&&o()};for(e=0;e<n.length;e++)i.Bind(n[e],"click",o),i.Bind(n[e],"keydown",l)},f.prototype.launchSurveyOrQualifier=function(){this._cvTimeout&&(clearTimeout(this._cvTimeout),this._cvTimeout=null);for(var e=document.querySelectorAll("*[acsshowwhenloading=true]"),t=0;t<e.length;t++)i.addClass(e[t],"acsDisplay");for(var r=document.querySelectorAll("*[acshidewhenloading=true]"),s=0;s<r.length;s++)i.removeClass(r[s],"acsDisplay"),i.addClass(r[s],"acsNoDisplay");var a=this.data.cfg.active_surveydef.qualifier,n=this.data.cfg.active_surveydef.reminder;a&&a.useQualifier?this.goToQualifier():n&&n.useReminder?this.goToReminder():this.goToSurvey(null)},f.prototype.goToQualifier=function(){this.qualifier=new a(this.br,this.cpps,this.data,this.data.cfg.active_surveydef.qualifier,this.qualhtml,this._displayOpts),this.qualifier.qualified.subscribe(t.proxy(function(){this.jrny.addEventString(r.QUALIFIER_ACCEPTED),this.goToSurvey(this.qualifier)},this),!0,!1),this.qualifier.disqualified.subscribe(t.proxy(function(){this.jrny.addEventString(r.QUALIFIER_DECLINED)},this),!0,!1),this.qualifier.render(),this.jrny.addEventString(r.QUALIFIER_SHOWN)},f.prototype.goToReminder=function(){this.reminder=new n(this.br,this.cpps,this.data,this.data.cfg.active_surveydef.reminder,this.rmdrhtml,this._displayOpts),this.reminder.accepted.subscribe(t.proxy(function(){this.jrny.addEventString(r.REMINDER_ACCEPTED),this.goToSurvey()},this),!0,!1),this.reminder.render(),this.jrny.addEventString(r.REMINDER_SHOWN)},f.prototype.goToSurvey=function(e){var i=new o(this.data.cfg,this.cpps,this.data.cfg.active_surveydef,this.qualifier),r=i.getUrl();window.resizeBy(0,200),window.focus(),setTimeout(t.proxy(function(){this._doSizing(),window.location=r},this),100)},t.winReady(function(){var e,r=setTimeout(function(){window.close()},13e3),s=new i.Browser;s.ready.subscribe(function(){var a=i.getBrainStorage(s,t.getParam("uid"));a.ready.subscribe(function(){a.setUpdateInterval(1e3),a.watchForChanges(["trackerinfo","trackercmd","ckcpps"],function(n,o,l){if("trackercmd"==n)switch(l.method){case"close":window.close();break;case"survey":e&&e.goToSurvey&&e.goToSurvey()}else if("ckcpps"==n&&e)t.ext(e.cpps._extras,l);else if("trackerinfo"==n)if(t.isDefined(e)&&e.data.cfg.active_surveydef.name===l.cfg.active_surveydef.name||a.setUpdateInterval(5e3),t.isDefined(e)){var c=e.data.cfg.active_surveydef,u=l.cfg.active_surveydef;(c.name!==u.name||c.site!==u.site||c.section!==u.section||c.language&&c.language.locale!=u.language.locale)&&(e.update(s,a,l),e.renderTemplate())}else e=new f(s,i.getBrainStorage(s,a.uid),l),window.Tracker=e,e.ready.subscribe(function(){clearTimeout(r),e.renderTemplate()},!0,!0)}.bind(this),!1,!0)}.bind(this),!0,!0)},!0,!0)})});